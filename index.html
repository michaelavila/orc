<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Orc by michaelavila</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Orc</h1>
        <p>Asynchronous flow control library</p>

        <p class="view"><a href="https://github.com/michaelavila/orc">View the Project on GitHub <small>michaelavila/orc</small></a></p>


        <ul>
          <li><a href="https://github.com/michaelavila/orc/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/michaelavila/orc/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/michaelavila/orc">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="orc" class="anchor" href="#orc"><span class="octicon octicon-link"></span></a>orc</h1>

<p>Orc orchestrates the execution of lists of functions. This library will help you:</p>

<ol>
<li>clearly and concisely express asynchronous flow</li>
<li>do so without interfering with your API</li>
</ol><p>Get it from npm:</p>

<pre><code>npm install orc
</code></pre>

<h2>
<a name="example" class="anchor" href="#example"><span class="octicon octicon-link"></span></a>Example</h2>

<p>The following example is typical: make an HTTP request for some content and
render that content in some way once we receive it. Here we tell orc to
sequence the two functions loadData and renderPage. In the loadData function we
tell orc to waitFor a response and then to wait for the data to finish loading.
The renderPage function just logs "now render the page" to the console.</p>

<div class="highlight"><pre><span class="nv">orc = </span><span class="nx">require</span><span class="p">(</span><span class="s">'./lib/orc'</span><span class="p">).</span><span class="nx">orc</span>

<span class="nv">loadData = </span><span class="nf">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">'load the data and wait'</span>
    <span class="nv">http = </span><span class="nx">require</span> <span class="s">'http'</span>
    <span class="nv">options =</span>
        <span class="nv">host: </span><span class="s">'google.com'</span>
        <span class="nv">port: </span><span class="mi">80</span>
        <span class="nv">path: </span><span class="s">''</span>

    <span class="nv">handleHTTPGet = </span><span class="nf">(response) -&gt;</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">setEncoding</span> <span class="s">'utf8'</span>

        <span class="nv">handleData = </span><span class="nf">(chunk) -&gt;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">"data loaded </span><span class="si">#{</span><span class="nx">chunk</span><span class="si">}</span><span class="s">"</span>

        <span class="nx">response</span><span class="p">.</span><span class="nx">on</span> <span class="s">'data'</span><span class="p">,</span> <span class="nx">handleData</span>

        <span class="c1"># here we wait as well</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">on</span> <span class="s">'end'</span><span class="p">,</span> <span class="nx">orc</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">()</span>

    <span class="c1"># here we wait</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">get</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">orc</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">(</span><span class="nx">handleHTTPGet</span><span class="p">)</span>

<span class="nv">renderPage = </span><span class="nf">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">'now render the page'</span>


<span class="c1"># this is where we initiate the sequence</span>
<span class="nx">orc</span><span class="p">.</span><span class="nx">sequence</span> <span class="nx">loadData</span><span class="p">,</span> <span class="nx">renderPage</span>
</pre></div>

<p>If you run the example you will see that everything is called in the correct
order. The renderPage function does not run until we have received all of the
data from the loadData function. I've listed the output below:</p>

<div class="highlight"><pre><span class="nv">$ </span>coffee example.coffee
load the data and <span class="nb">wait</span>
data loaded &lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv<span class="o">=</span><span class="s2">"content-type"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"text/html;charset=utf-8"</span>&gt;
&lt;TITLE&gt;301 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;
&lt;H1&gt;301 Moved&lt;/H1&gt;
The document has moved
&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">"http://www.google.com/"</span>&gt;here&lt;/A&gt;.
&lt;/BODY&gt;&lt;/HTML&gt;

now render the page
</pre></div>

<h2>
<a name="how-does-it-work" class="anchor" href="#how-does-it-work"><span class="octicon octicon-link"></span></a>How does it work?</h2>

<p>Orc does as much of the bookkeeping as it can. You should almost never need
anything more than the sequence, waitFor, and errorOn functions. Like anything
else the more you know about orc the easier it is to work with.</p>

<h3>
<a name="sequence" class="anchor" href="#sequence"><span class="octicon octicon-link"></span></a>sequence</h3>

<p>Everything begins with you telling orc to sequence some functions. Orc places
these condemned functions into an ExecutionContext. The context lets orc keep
the details of each execution separated. These details are things like the
functions being executed and whether or not the execution is on hold for
anything. At this point orc will begin executing, if it's not already.</p>

<p>Orc can execute both dependent and independent sequences. A sequence is dependent
when it requires another sequence to complete before it completes. Dependent
sequences are called inside of other sequences kinda like this:</p>

<div class="highlight"><pre><span class="nx">orc</span><span class="p">.</span><span class="nx">sequence</span> <span class="nf">-&gt;</span>
  <span class="nx">orc</span><span class="p">.</span><span class="nx">sequence</span> <span class="p">...</span>
</pre></div>

<p>Independent sequences on the other hand look kinda like this:</p>

<div class="highlight"><pre><span class="nx">orc</span><span class="p">.</span><span class="nx">sequence</span> <span class="p">...</span>
<span class="nx">orc</span><span class="p">.</span><span class="nx">sequence</span> <span class="p">...</span>
</pre></div>

<p>Whether or not one sequence depends on another sequence determines where orc
puts the execution context. If the sequence is independent orc will add it
alongside whatever other contexts exist. If the sequence is dependent orc
will stack the context on top of whichever context depends on it. Orc then
manages these dependencies by only executing from the context at the top of of
each stack.</p>

<h3>
<a name="waitfor" class="anchor" href="#waitfor"><span class="octicon octicon-link"></span></a>waitFor</h3>

<p>The waitFor decorator is simple. First it saves the current context so that
later on it can determine which context the decorated function belongs to. Then
it returns a function that wraps the callback it was provided.</p>

<p>The decorated function that waitFor returns will set the current context to the
context that was saved earlier. This ensures that any waitFor calls made during
the callback will be routed to the correct context. At the very end, once it
has executed the callback, the waitFor function will call done on the correct
context.</p>

<h2>
<a name="getting-started" class="anchor" href="#getting-started"><span class="octicon octicon-link"></span></a>Getting Started</h2>

<p><strong>1)</strong> Require orc</p>

<div class="highlight"><pre><span class="nv">orc = </span><span class="nx">require</span><span class="p">(</span><span class="s">'orc'</span><span class="p">).</span><span class="nx">orc</span>
</pre></div>

<p><strong>2)</strong> Sequence some functions</p>

<div class="highlight"><pre><span class="nv">loadContent = </span><span class="nf">-&gt;</span>
<span class="nv">bar = </span><span class="nf">-&gt;</span>

<span class="nx">orc</span><span class="p">.</span><span class="nx">sequence</span> <span class="nx">foo</span><span class="p">,</span> <span class="nx">bar</span>
</pre></div>

<p><strong>3)</strong> Wait for some stuff</p>

<div class="highlight"><pre><span class="nv">loadContent = </span><span class="nf">-&gt;</span>
  <span class="nv">request = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">get</span> <span class="nx">someDataUrl</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">on</span> <span class="s">'data'</span><span class="p">,</span> <span class="nx">orc</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">(</span><span class="nx">parseData</span><span class="p">)</span>

<span class="nv">renderContent = </span><span class="nf">-&gt;</span>
  <span class="nx">animator</span><span class="p">.</span><span class="nx">do</span> <span class="nx">animationOptions</span> <span class="nx">orc</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">()</span>

<span class="nx">orc</span><span class="p">.</span><span class="nx">sequence</span> <span class="nx">loadContent</span><span class="p">,</span> <span class="nx">renderContent</span>
</pre></div>

<p><strong>4)</strong> Tell orc how to error</p>

<div class="highlight"><pre><span class="nv">loadContent = </span><span class="nf">-&gt;</span>
  <span class="nv">request = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">get</span> <span class="nx">someDataUrl</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">on</span> <span class="s">'data'</span><span class="p">,</span> <span class="nx">orc</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">(</span><span class="nx">parseData</span><span class="p">)</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">on</span> <span class="s">'error'</span><span class="p">,</span> <span class="nx">orc</span><span class="p">.</span><span class="nx">errorOn</span><span class="p">()</span>

<span class="nv">renderContent = </span><span class="nf">-&gt;</span>
  <span class="nx">animator</span><span class="p">.</span><span class="nx">do</span> <span class="nx">animationOptions</span> <span class="nx">orc</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">()</span>

<span class="nx">orc</span><span class="p">.</span><span class="nx">sequence</span> <span class="nx">loadContent</span><span class="p">,</span> <span class="nx">renderContent</span>
</pre></div>

<p><strong>5)</strong> Handle sequence error instead of erroring</p>

<div class="highlight"><pre><span class="nv">loadContent = </span><span class="nf">-&gt;</span>
  <span class="nv">request = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">get</span> <span class="nx">someDataUrl</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">on</span> <span class="s">'data'</span><span class="p">,</span> <span class="nx">orc</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">(</span><span class="nx">parseData</span><span class="p">)</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">on</span> <span class="s">'error'</span><span class="p">,</span> <span class="nx">orc</span><span class="p">.</span><span class="nx">errorOn</span><span class="p">()</span>

<span class="nv">renderContent = </span><span class="nf">-&gt;</span>
  <span class="nx">animator</span><span class="p">.</span><span class="nx">do</span> <span class="nx">animationOptions</span> <span class="nx">orc</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">()</span>

<span class="nv">context = </span><span class="nx">orc</span><span class="p">.</span><span class="nx">sequence</span> <span class="nx">loadContent</span><span class="p">,</span> <span class="nx">renderContent</span>
<span class="nv">context.handleError = </span><span class="nf">(error, context) -&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">"</span><span class="si">#{</span><span class="nx">error</span><span class="si">}</span><span class="s"> for </span><span class="si">#{</span><span class="nx">context</span><span class="si">}</span><span class="s">"</span>
</pre></div>

<p>That's it.</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/michaelavila">michaelavila</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>